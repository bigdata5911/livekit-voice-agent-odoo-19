<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="voice_agent.ChatWidget" owl="1">
        <div class="voice-chat-widget-container" t-if="isVisible">
            <div class="voice-chat-widget">
            <div class="chat-widget-header" t-on-click="toggleMinimize">
                <div class="header-content">
                    <i class="fa fa-comments"/>
                    <span t-esc="agentName"/>
                    <!-- Voice Activity Indicator -->
                    <span t-if="state.isConnected" class="voice-indicator">
                        <i t-attf-class="fa fa-microphone {{state.isAgentSpeaking ? 'pulsing' : ''}}" 
                           t-att-title="state.isAgentSpeaking ? 'Agent is speaking' : 'Voice active'"/>
                    </span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-sm btn-link" t-on-click.stop="toggleMinimize">
                        <i t-attf-class="fa {{isMinimized ? 'fa-window-maximize' : 'fa-window-minimize'}}"/>
                    </button>
                    <button class="btn btn-sm btn-link" t-on-click.stop="closeChat">
                        <i class="fa fa-times"/>
                    </button>
                </div>
            </div>
            
            <div t-if="!isMinimized" class="chat-widget-content">
                <div t-if="state.error" class="alert alert-danger" role="alert">
                    <t t-esc="state.error"/>
                </div>
                
                <!-- Chat Messages Area -->
                <div t-if="state.isConnected" class="chat-messages">
                    <div t-foreach="state.messages" t-as="msg" t-key="msg_index" 
                         t-att-class="'message message-' + msg.sender + (msg.streaming ? ' streaming' : '')">
                        <div class="message-content">
                            <div class="message-sender">
                                <span t-esc="msg.sender === 'user' ? 'YOU' : (msg.sender === 'agent' ? 'AGENT' : 'SYSTEM')"/>
                                <span t-if="msg.isTranscript" class="transcript-badge">
                                    <i class="fa fa-microphone"/> Transcript
                                </span>
                            </div>
                            <div class="message-text" t-esc="msg.text"/>
                            <div t-if="msg.streaming" class="streaming-indicator">
                                <span class="typing-dots">
                                    <span></span><span></span><span></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Text Input Area - Always visible when connected -->
                <div t-if="state.isConnected" class="chat-input-area">
                    <div class="input-group">
                        <input 
                            type="text"
                            class="form-control" 
                            placeholder="Type a message"
                            t-model="state.messageInput"
                            t-on-keydown="onMessageInputKeydown"/>
                        <button 
                            class="btn btn-primary" 
                            t-on-click="sendTextMessage"
                            t-att-disabled="!state.messageInput.trim()">
                            SEND
                        </button>
                    </div>
                    <div class="voice-status-hint" t-if="state.isUserSpeaking">
                        <i class="fa fa-microphone"/> You're speaking...
                    </div>
                </div>
                
                <!-- Connection Controls -->
                <div class="chat-widget-actions">
                    <button 
                        t-if="!state.isConnected"
                        class="btn btn-primary btn-block"
                        t-on-click="connectToVoice"
                        t-att-disabled="state.isConnecting or !state.livekitLoaded">
                        <i class="fa fa-plug"/> Connect
                    </button>
                    <button 
                        t-if="state.isConnected"
                        class="btn btn-danger btn-block"
                        t-on-click="disconnect">
                        <i class="fa fa-stop"/> Disconnect
                    </button>
                </div>
            </div>
        </div>
        </div>
    </t>
</templates>

